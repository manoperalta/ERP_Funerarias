{% extends 'base.html' %}
{% load static %}

{% block title %}Dashboard {{ cargo }} - Sistema Funerária{% endblock %}

{% block extra_css %}
<style>
    .funcionario-header {
        background: linear-gradient(135deg, #2c3e50 0%, #34495e 100%);
        color: white;
        padding: 30px 0;
        margin-bottom: 30px;
    }
    .stats-card {
        background: linear-gradient(135deg, #3498db 0%, #2980b9 100%);
        color: white;
        border-radius: 15px;
        padding: 25px;
        text-align: center;
        margin-bottom: 20px;
        box-shadow: 0 4px 15px rgba(0,0,0,0.1);
        transition: transform 0.3s ease;
    }
    .stats-card:hover {
        transform: translateY(-5px);
    }
    .stats-number {
        font-size: 2.5rem;
        font-weight: bold;
        margin-bottom: 5px;
    }
    .stats-label {
        font-size: 0.9rem;
        opacity: 0.9;
    }
    .stats-mini {
        text-align: center;
        min-width: 70px;
    }
    .todo-card {
        background: white;
        border-radius: 15px;
        padding: 20px;
        margin-bottom: 20px;
        box-shadow: 0 4px 15px rgba(0,0,0,0.1);
        border-left: 5px solid #3498db;
        transition: all 0.3s ease;
    }
    .todo-card:hover {
        transform: translateY(-3px);
        box-shadow: 0 8px 25px rgba(0,0,0,0.15);
    }
    .todo-card.hoje {
        border-left-color: #e74c3c;
        background: linear-gradient(135deg, #fff 0%, #ffebee 100%);
    }
    .todo-card.amanha {
        border-left-color: #f39c12;
        background: linear-gradient(135deg, #fff 0%, #fff8e1 100%);
    }
    .todo-card.urgente {
        border-left-color: #e67e22;
        background: linear-gradient(135deg, #fff 0%, #fef5e7 100%);
    }
    .falecido-img-container {
        width: 80px;
        height: 80px;
        border-radius: 50%;
        overflow: hidden;
        margin-right: 20px;
        border: 3px solid #ecf0f1;
    }
    .falecido-img-container img {
        width: 100%;
        height: 100%;
        object-fit: cover;
    }
    .todo-header {
        display: flex;
        align-items: center;
        margin-bottom: 20px;
    }
    .data-sepultamento {
        color: #7f8c8d;
        font-size: 0.9rem;
    }
    .urgencia-badge {
        padding: 5px 15px;
        border-radius: 20px;
        font-size: 0.8rem;
        font-weight: bold;
        text-transform: uppercase;
    }
    .urgencia-hoje {
        background: #e74c3c;
        color: white;
    }
    .urgencia-amanha {
        background: #f39c12;
        color: white;
    }
    .urgencia-urgente {
        background: #e67e22;
        color: white;
    }
    .urgencia-normal {
        background: #95a5a6;
        color: white;
    }
    .task-list {
        background: #f8f9fa;
        border-radius: 10px;
        padding: 15px;
        margin-top: 15px;
    }
    .task-item {
        padding: 8px 0;
        border-bottom: 1px solid #ecf0f1;
    }
    .task-item:last-child {
        border-bottom: none;
    }
    .servico-item {
        background: #e8f5e8;
        border-radius: 8px;
        padding: 10px;
        margin: 5px 0;
        border-left: 3px solid #27ae60;
    }
    .dashboard-stats {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white;
        border-radius: 15px;
        padding: 20px;
        margin-bottom: 20px;
    }
    .dashboard-stats .icon {
        font-size: 2rem;
        opacity: 0.8;
    }
    .dashboard-stats .value {
        font-size: 1.5rem;
        font-weight: bold;
        margin: 5px 0;
    }
    .dashboard-stats .label {
        font-size: 0.8rem;
        opacity: 0.9;
    }
</style>
{% endblock %}

{% block content %}
<div class="funcionario-header">
    <div class="container">
        <div class="row align-items-center">
            <div class="col-md-8">
                <h1><i class="bi bi-person-workspace"></i> Dashboard {{ cargo }}</h1>
                <p class="mb-0">Bem-vindo, {{ user.get_full_name|default:user.username }}!</p>
                <small>Sistema de Tarefas Organizadas por Sepultamentos</small>
            </div>
            <div class="col-md-4 text-end">
                <div class="d-flex justify-content-end gap-2">
                    <div class="stats-mini bg-white bg-opacity-20 rounded p-2">
                        <div class="h5 mb-0">{{ total_sepultamentos }}</div>
                        <small>Total</small>
                    </div>
                    <div class="stats-mini bg-white bg-opacity-20 rounded p-2">
                        <div class="h5 mb-0">{{ sepultamentos_hoje }}</div>
                        <small>Hoje</small>
                    </div>
                    <div class="stats-mini bg-white bg-opacity-20 rounded p-2">
                        <div class="h5 mb-0">{{ sepultamentos_urgentes }}</div>
                        <small>Urgentes</small>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<div class="container">
    <!-- Cards de Estatísticas Gerais -->
    <div class="row mb-4">
        <div class="col-md-3">
            <div class="dashboard-stats text-center">
                <div class="icon">
                    <i class="bi bi-people-fill"></i>
                </div>
                <div class="value">{{ total_funcionarios }}</div>
                <div class="label">Total Funcionários</div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="dashboard-stats text-center" style="background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);">
                <div class="icon">
                    <i class="bi bi-calendar-event"></i>
                </div>
                <div class="value">{{ total_agendamentos }}</div>
                <div class="label">Total Agendamentos</div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="dashboard-stats text-center" style="background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%);">
                <div class="icon">
                    <i class="bi bi-clock-history"></i>
                </div>
                <div class="value">{{ agendamentos_pendentes }}</div>
                <div class="label">Pendentes (7 dias)</div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="dashboard-stats text-center" style="background: linear-gradient(135deg, #43e97b 0%, #38f9d7 100%);">
                <div class="icon">
                    <i class="bi bi-check-circle"></i>
                </div>
                <div class="value">{{ tarefas_concluidas }}</div>
                <div class="label">Concluídas (Mês)</div>
            </div>
        </div>
    </div>

    <!-- Estatísticas Rápidas -->
    <div class="row mb-4">
        <div class="col-md-4">
            <div class="stats-card">
                <div class="stats-number">{{ total_sepultamentos }}</div>
                <div class="stats-label">Sepultamentos Próximos</div>
            </div>
        </div>
        <div class="col-md-4">
            <div class="stats-card" style="background: linear-gradient(135deg, #e74c3c 0%, #c0392b 100%);">
                <div class="stats-number">{{ sepultamentos_hoje }}</div>
                <div class="stats-label">Para Hoje</div>
            </div>
        </div>
        <div class="col-md-4">
            <div class="stats-card" style="background: linear-gradient(135deg, #f39c12 0%, #e67e22 100%);">
                <div class="stats-number">{{ sepultamentos_urgentes }}</div>
                <div class="stats-label">Urgentes</div>
            </div>
        </div>
    </div>

    <!-- Lista de To-Do Cards -->
    <div class="row">
        <div class="col-12">
            <h3><i class="bi bi-list-check"></i> Suas Tarefas por Sepultamento</h3>
            <p class="text-muted mb-4">Organizadas por data e hora do sepultamento</p>
        </div>
    </div>

    {% if todo_cards %}
        {% for card in todo_cards %}
        <div class="todo-card {{ card.urgencia }}">
            <div class="todo-header">
                <div class="falecido-img-container">
                    {% if card.agendamento.pessoa_falecida.imagem %}
                        <img src="{{ card.agendamento.pessoa_falecida.imagem.url }}" alt="Foto de {{ card.agendamento.pessoa_falecida.nome }}">
                    {% else %}
                        <img src="{% static 'img/default_placeholder.png' %}" alt="Imagem Padrão">
                    {% endif %}
                </div>
                <div class="flex-grow-1">
                    <div class="row align-items-center">
                        <div class="col-md-6">
                            <h5 class="mb-1">
                                <i class="bi bi-person-x"></i> 
                                {{ card.agendamento.pessoa_falecida.nome }}
                            </h5>
                            <div class="data-sepultamento">
                                <i class="bi bi-calendar-event"></i>
                                {{ card.agendamento.data_sepultamento|date:"d/m/Y H:i" }}
                            </div>
                        </div>
                        <div class="col-md-3">
                            <div class="text-center">
                                <span class="urgencia-badge urgencia-{{ card.urgencia }}">
                                    {% if card.urgencia == 'hoje' %}
                                        Hoje
                                    {% elif card.urgencia == 'amanha' %}
                                        Amanhã
                                    {% elif card.urgencia == 'urgente' %}
                                        Urgente
                                    {% else %}
                                        {{ card.dias_restantes }} dias
                                    {% endif %}
                                </span>
                            </div>
                        </div>
                        <div class="col-md-3 text-end">
                            <a href="{% url 'agendamento:detail' card.agendamento.pk %}" class="btn btn-outline-primary btn-sm">
                                <i class="bi bi-eye"></i> Ver Detalhes
                            </a>
                        </div>
                    </div>
                </div>
            </div>

            <div class="row">
                <!-- Suas Tarefas Específicas -->
                <div class="col-md-6">
                    <h6><i class="bi bi-person-check"></i> Suas Tarefas ({{ cargo }})</h6>
                    <div class="task-list">
                        {% for tarefa in card.tarefas_usuario %}
                        <div class="task-item">
                            <i class="bi bi-square text-muted"></i>
                            {{ tarefa }}
                        </div>
                        {% empty %}
                        <div class="task-item text-muted">
                            <i class="bi bi-info-circle"></i>
                            Nenhuma tarefa específica definida para seu cargo
                        </div>
                        {% endfor %}
                    </div>
                </div>

                <!-- Serviços Contratados -->
                <div class="col-md-6">
                    <h6><i class="bi bi-gear"></i> Serviços Contratados</h6>
                    <div class="task-list">
                        {% for servico in card.servicos_contratados %}
                        <div class="servico-item">
                            <strong>{{ servico.item_servico.nome }}</strong><br>
                            <small class="text-muted">
                                Qtd: {{ servico.quantidade }} | 
                                R$ {{ servico.preco_total|floatformat:2 }}
                            </small>
                        </div>
                        {% empty %}
                        <div class="task-item text-muted">
                            <i class="bi bi-info-circle"></i>
                            Nenhum serviço contratado
                        </div>
                        {% endfor %}
                    </div>
                </div>
            </div>
        </div>
        {% endfor %}
    {% else %}
        <div class="text-center py-5">
            <i class="bi bi-calendar-x" style="font-size: 4rem; color: #bdc3c7;"></i>
            <h4 class="mt-3 text-muted">Nenhum sepultamento próximo</h4>
            <p class="text-muted">Não há sepultamentos agendados para os próximos 7 dias.</p>
            <a href="{% url 'agendamento:list' %}" class="btn btn-primary">
                <i class="bi bi-calendar-plus"></i> Ver Todos os Agendamentos
            </a>
        </div>
    {% endif %}
</div>
{% endblock %}

