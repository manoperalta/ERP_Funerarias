{% extends 'base.html' %}

{% block title %}Relatórios de Estoque - Sistema Funerária{% endblock %}

{% block content %}
<div class="container mt-4">
    <h2>Relatórios de Estoque</h2>

    <div class="mb-3">
        <label for="periodoSelect" class="form-label">Selecionar Período:</label>
        <select class="form-select" id="periodoSelect" onchange="location = this.value;">
            <option value="{% url 'estoque:relatorios' %}?periodo=diario" {% if periodo == 'diario' %}selected{% endif %}>Diário</option>
            <option value="{% url 'estoque:relatorios' %}?periodo=semanal" {% if periodo == 'semanal' %}selected{% endif %}>Semanal</option>
            <option value="{% url 'estoque:relatorios' %}?periodo=mensal" {% if periodo == 'mensal' %}selected{% endif %}>Mensal</option>
            <option value="{% url 'estoque:relatorios' %}?periodo=anual" {% if periodo == 'anual' %}selected{% endif %}>Anual</option>
        </select>
    </div>

    <div class="card mb-4">
        <div class="card-header bg-primary text-white">
            <h5>Resumo do Período: {{ data_inicio|date:"d/m/Y" }} - {{ data_fim|date:"d/m/Y" }}</h5>
        </div>
        <div class="card-body">
            <div class="row text-center">
                <div class="col-md-6">
                    <h4>Entradas: <span class="text-success">{{ total_entradas|floatformat:2 }}</span></h4>
                    <p>Valor Total: R$ {{ valor_entradas|floatformat:2 }}</p>
                </div>
                <div class="col-md-6">
                    <h4>Saídas: <span class="text-danger">{{ total_saidas|floatformat:2 }}</span></h4>
                    <p>Valor Total: R$ {{ valor_saidas|floatformat:2 }}</p>
                </div>
            </div>
        </div>
    </div>

    <div class="card mb-4">
        <div class="card-header bg-info text-white">
            <h5>Movimentações Detalhadas</h5>
        </div>
        <div class="card-body">
            {% if movimentacoes %}
            <div class="table-responsive">
                <table class="table table-striped table-hover">
                    <thead>
                        <tr>
                            <th>Data</th>
                            <th>Produto</th>
                            <th>Tipo</th>
                            <th>Quantidade</th>
                            <th>Preço Unitário</th>
                            <th>Valor Total</th>
                            <th>Usuário</th>
                            <th>Observações</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for mov in movimentacoes %}
                        <tr>
                            <td>{{ mov.data_movimentacao|date:"d/m/Y H:i" }}</td>
                            <td>{{ mov.produto.nome }}</td>
                            <td>{{ mov.get_tipo_display }}</td>
                            <td>{{ mov.quantidade|floatformat:2 }}</td>
                            <td>R$ {{ mov.preco_unitario|floatformat:2 }}</td>
                            <td>R$ {{ mov.valor_total|floatformat:2 }}</td>
                            <td>{{ mov.usuario.username }}</td>
                            <td>{{ mov.observacoes|default:"-" }}</td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
            {% else %}
            <div class="alert alert-info" role="alert">
                Nenhuma movimentação encontrada para o período selecionado.
            </div>
            {% endif %}
        </div>
    </div>

    <div class="card mb-4">
        <div class="card-header bg-warning text-white">
            <h5>Produtos com Estoque Baixo</h5>
        </div>
        <div class="card-body">
            {% if produtos_baixo_estoque %}
            <ul class="list-group">
                {% for produto in produtos_baixo_estoque %}
                <li class="list-group-item d-flex justify-content-between align-items-center">
                    {{ produto.nome }} (Qtd Atual: {{ produto.quantidade_atual|floatformat:2 }} / Mínima: {{ produto.quantidade_minima|floatformat:2 }})
                    <span class="badge bg-danger rounded-pill">Atenção</span>
                </li>
                {% endfor %}
            </ul>
            {% else %}
            <div class="alert alert-success" role="alert">
                Nenhum produto com estoque baixo no momento. Tudo certo!
            </div>
            {% endif %}
        </div>
    </div>

    <div class="card">
        <div class="card-header bg-danger text-white">
            <h5>Alertas Recentes de Estoque</h5>
        </div>
        <div class="card-body">
            {% if alertas_estoque %}
            <ul class="list-group">
                {% for alerta in alertas_estoque %}
                <li class="list-group-item">
                    <strong>{{ alerta.get_tipo_alerta_display }}:</strong> {{ alerta.mensagem }} ({{ alerta.data_criacao|date:"d/m/Y H:i" }})
                </li>
                {% endfor %}
            </ul>
            {% else %}
            <div class="alert alert-info" role="alert">
                Nenhum alerta de estoque recente.
            </div>
            {% endif %}
        </div>
    </div>

</div>
{% endblock %}


